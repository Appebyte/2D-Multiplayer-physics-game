<html>

<head>
    <title>Physics test</title>
    <style>
    html,
    body {
        overflow: hidden;
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
    }
    </style>
</head>
<script src="node_modules/p2/build/p2.js"></script>
<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>

<body>
    <canvas style="border: 1px solid black;" width="800" height="600"id="canvas"></canvas>
    <script>
    var canvas, ctx, w, h,
        world, planeBody;

    var players = [];
    var mainPlayerId;

    var Player = function(id, x, y) {
        this.id = id;
        this.circleShape = new p2.Circle({
            radius: 1,
        });
        this.circleBody = new p2.Body({
            mass: 1,
            position: [x, y],
            angularVelocity: 1
        });
        this.circleBody.damping = .8;
        this.circleBody.addShape(this.circleShape);
        
        this.draw = function() {
            ctx.beginPath();
            var x = this.circleBody.position[0],
                y = this.circleBody.position[1];
            ctx.save();
            ctx.translate(x, y); // Translate to the center of the circle
            ctx.rotate(this.circleBody.angle); // Rotate to the circle body frame
            ctx.arc(0, 0, 1, 0, 2 * Math.PI);
            ctx.fillStyle = 'orange';
            ctx.fill();
            ctx.stroke();
            ctx.restore();
        };

        this.shadowX = x;
        this.shadowY = y;

        this.drawShadow = function() {
            ctx.beginPath();
            ctx.save();
            ctx.translate(this.shadowX, this.shadowY); // Translate to the center of the circle
            ctx.rotate(this.circleBody.angle); // Rotate to the circle body frame
            
            ctx.arc(0, 0, 1, 0, 2 * Math.PI);
            ctx.stroke();
            ctx.restore();
        };
    };

    init();

    function init() {
        // Init canvas
        canvas = document.getElementById("canvas");
        w = canvas.width;
        h = canvas.height;

        ctx = canvas.getContext("2d");
        ctx.lineWidth = 0.05;

        // Init p2.js
        world = new p2.World({gravity:[0,0]});
        world.frictionGravity = 1;
        world.applyDamping = true;
    }

    function addPlayer(id,x,y) {
        var player = new Player(id, x,y);
        world.addBody(player.circleBody);
        players.push(player);
    }

    function render() {
        // Clear the canvas
        ctx.clearRect(0, 0, w, h);
        ctx.save();
        ctx.translate(w / 2, h / 2); // Translate to the center
        ctx.scale(30, -30); // Zoom in and flip y axis

        // Draw all bodies
        for(var i=0; i<players.length; i++) {
            players[i].draw();
            players[i].drawShadow();
        }

        // Restore transform
        ctx.restore();
    }
    var aCount = 0;
    var fixedTimeStep = 1 / 60, maxSubSteps = 10, lastTimeMilliseconds;

    setInterval(function() {
        world.step(1/60);
    },1000/60);

    draw();

    function draw() {
        requestAnimationFrame(draw);
        render();
    }
    

    // =========================================================================
    // Network code
    // =========================================================================

    var socket = io.connect();

    tryConnect();

    function tryConnect() {
        if(socket.emit('connect', null)) {
            console.log('Successfully connected.');
            connected();
        } else {
            setTimeout(function() {
                console.log('Attempting to connect another time..');
                tryConnect();
            },2000);    
        }
    }

    function connected() {
        getPlayers();
        getWorldDetails();
        addMainPlayer();
        addNewPlayer();
        receiveState();
        receiveImpulseState();
    }

    function getPlayers() {
        socket.emit('getPlayers', null);
        socket.on('getPlayers', function(playersData) {
            for(var i=0; i<playersData.length;i++) {
                addPlayer(playersData[i].id, playersData[i].position[0], playersData[i].position[1]);
                players[i].circleBody.velocity = playersData[i].velocity;
                players[i].circleBody.angularVelocity = playersData[i].angularVelocity;
            } 
        });
    }

    function getWorldDetails() {
        socket.emit('getWorldDetails', null);
        socket.on('getWorldDetails', function(data) {
            world.time = data.time;
        });
    }

    function addMainPlayer() {
        socket.emit('addMainPlayer', null);
        socket.on('addMainPlayer', function(player) {
            mainPlayerId = player.id;
            addPlayer(player.id, player.position[0], player.position[1]);
        });
    }

    function addNewPlayer() {
        socket.on('addNewPlayer', function(player) {
            addPlayer(player.id, player.position[0], player.position[1]);
        });
    }

    function receiveState() {
        socket.on('state', function(playersData) {
            for(var i=0; i<players.length; i++) {
                //players[i].circleBody.position = playersData[i].position;
                //players[i].circleBody.velocity = playersData[i].velocity;
                players[i].shadowX = playersData[i].position[0]
                players[i].shadowY = playersData[i].position[1];   
            }
        });
    }

    function trajectory(x, y) {
        currentId = mainPlayerId;
        currentX = x;
        currentY = y;
        request = true;

        socket.emit('impulse', {
            id: mainPlayerId,
            x: x,
            y: y
        });
    }

    function receiveImpulseState() {
        socket.on('impulseState', function(data) {
            if(data.id != mainPlayerId) {
                currentId = data.id;
                currentX = data.x;
                currentY = data.y;
                request = true;
            }
        });
    }

    function applyImpulse(id, x,y) {
        players[id].circleBody.applyImpulse([x, y],  players[id].circleBody.position);
    }

    var currentId;
    var currentX;
    var currentY;
    var request = false;

    world.on("postStep", function(){
        if(request) {
            players[currentId].circleBody.applyForce([currentX, currentY],  players[currentId].circleBody.position);
            request = false;
        }
        
    });

    function syncWithShadows() {
        for(var i=0; i<players.length; i++) {
            players[i].circleBody.position = [players[i].shadowX, players[i].shadowY];
        }
    }

    function areTheyInSync() {
        for(var i=0; i<players.length; i++) {
            if(players[i].circleBody.position[0] != players[i].shadowX) {
               console.log('X nog equal for ' + i + ', client: ' + players[i].circleBody.position[0] + '; server ' + players[i].shadowX);
            }
            if(players[i].circleBody.position[1] != players[i].shadowY) {
                console.log('Y nog equal for ' + i + ', client: ' + players[i].circleBody.position[1] + '; server ' + players[i].shadowY);
            }
        }
    }

   function print() {
        for(var i=0; i<players.length; i++) {
               console.log('X nog equal for ' + i + ', client: ' + players[i].circleBody.position[0] + '; server ' + players[i].shadowX);
            
                console.log('Y nog equal for ' + i + ', client: ' + players[i].circleBody.position[1] + '; server ' + players[i].shadowY);
            
        }
    }

    </script>
</body>
<script>
